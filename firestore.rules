rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user role from user_roles collection
    // Returns the role string (e.g., 'admin', 'owner', 'staff')
    function getUserRole() {
      return get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role;
    }

    // Check if user is admin or owner (has elevated privileges)
    function isAdminOrOwner() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
             getUserRole() in ['admin', 'owner'];
    }

    // Check if user has any role assigned
    function hasRole() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/user_roles/$(request.auth.uid));
    }

    // ========================================
    // USER ROLES COLLECTION
    // ========================================
    // Critical: This collection controls access to all other resources

    match /user_roles/{userId} {
      // Users can read their own role, admin/owner can read all roles
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        (exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role in ['admin', 'owner'])
      );

      // ONLY admin/owner can manage user roles (create, update, delete)
      // Users CANNOT set their own roles - this prevents privilege escalation
      allow write, delete: if isAuthenticated() && (
        exists(/databases/$(database)/documents/user_roles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/user_roles/$(request.auth.uid)).data.role in ['admin', 'owner']
      );
    }

    // Settings collection - authenticated users can read/write
    match /settings/{document=**} {
      allow read, write: if isAuthenticated();
    }

    // Orders collection - authenticated users can read/write
    match /orders/{orderId} {
      allow read, write: if isAuthenticated();
    }

    // Team collection - authenticated users can read/write
    match /team/{teamId} {
      allow read, write: if isAuthenticated();
    }

    // Inventory collection - public can read (for quotation website), authenticated users can write
    match /inventory/{document=**} {
      allow read: if true;  // Public read access for quotation website to display product images
      allow write: if isAuthenticated();  // Only authenticated users can modify inventory
    }

    // Item History collection - authenticated users can read/write
    match /itemHistory/{historyId} {
      allow read, write: if isAuthenticated();
    }

    // Counters collection - authenticated users can read/write
    match /counters/{counterId} {
      allow read, write: if isAuthenticated();
    }

    // Products collection - authenticated users can read/write
    match /products/{productId} {
      allow read, write: if isAuthenticated();
    }

    // Categories collection - authenticated users can read/write
    match /categories/{categoryId} {
      allow read, write: if isAuthenticated();
    }

    // Customer requests collection - authenticated users can read/write
    match /customer_requests/{requestId} {
      allow read, write: if isAuthenticated();
    }

    // Tracking collection - allow public writes for analytics, authenticated reads
    match /tracking/{trackingId} {
      allow write: if true;  // Allow public writes for tracking
      allow read: if isAuthenticated();  // Only authenticated users can read
    }

    // Notifications collection - authenticated users can read/write
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated();
    }

    // User profiles - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ========================================
    // FINANCIAL COLLECTIONS - ADMIN/OWNER ONLY
    // ========================================
    // These collections contain sensitive financial data
    // Only users with 'admin' or 'owner' role can access

    // Payments collection - tracks customer payments
    match /payments/{paymentId} {
      allow read, write: if isAdminOrOwner();
    }

    // Expenses collection - tracks business expenses
    match /expenses/{expenseId} {
      allow read, write: if isAdminOrOwner();
    }

    // Financial summary collection - aggregated financial data
    match /financial_summary/{summaryId} {
      allow read, write: if isAdminOrOwner();
    }

    // ========================================
    // QUOTATIONS COLLECTION
    // ========================================
    // Quotations collection - authenticated users can read/write
    // Used for creating and managing customer quotations
    match /quotations/{quotationId} {
      allow read, write: if isAuthenticated();
    }

    // ========================================
    // ADMIN COLLECTION
    // ========================================
    // Admin collection - stores admin panel data like videos
    // Authenticated users can write, public can read (for website)
    match /admin/{document=**} {
      allow read: if true;  // Allow public read access for website
      allow write: if isAuthenticated();  // Authenticated users can write
    }

    // ========================================
    // ADVERTISEMENTS COLLECTION
    // ========================================
    // Advertisements collection - stores ads displayed on website
    // Authenticated users can write, public can read (for website display)
    match /advertisements/{adId} {
      allow read: if true;  // Allow public read access for website
      allow write: if isAuthenticated();  // Authenticated users can write
    }

    // ========================================
    // PACKAGES COLLECTION
    // ========================================
    // Packages collection - stores pre-made package templates
    // Public can read (for website), authenticated users can write (admin panel)
    match /packages/{packageId} {
      allow read: if true;  // Allow public read access for website
      allow write: if isAuthenticated();  // Authenticated users can write
    }

    // ========================================
    // LEADS COLLECTION
    // ========================================
    // Leads collection - stores customer lead submissions from website
    // Public can create (website submissions), authenticated users can read/update (admin panel)
    match /leads/{leadId} {
      allow create: if true;  // Allow public create for website submissions
      allow read, update, delete: if isAuthenticated();  // Authenticated users can manage leads
    }

    // ========================================
    // MARKETING & CONVERSION COLLECTIONS
    // ========================================
    // Collections for conversion optimization features managed via Marketing tab
    // Public can read (for website display), authenticated users can write (admin panel)

    // Exit Intent Popups - displays popups when visitors try to leave
    match /exit_intent_popups/{popupId} {
      allow read: if true;  // Public read for website display
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Popup Settings - global configuration for exit intent popup behavior
    match /popup_settings/{document=**} {
      allow read: if true;  // Public read for website to load settings
      allow write: if isAuthenticated();  // Authenticated users can manage settings
    }

    // Social Proof Notifications - "X just booked..." notifications
    match /social_proof_notifications/{notificationId} {
      allow read: if true;  // Public read for website display
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Sticky Bars - top/bottom announcement bars
    match /sticky_bars/{barId} {
      allow read: if true;  // Public read for website display
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Testimonials - customer reviews and video testimonials
    match /testimonials/{testimonialId} {
      allow read: if true;  // Public read for website display
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Before/After Gallery - transformation comparison images
    match /before_after_gallery/{galleryId} {
      allow read: if true;  // Public read for website display
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Trust Elements - badges, certifications, trust indicators
    match /trust_elements/{elementId} {
      allow read: if true;  // Public read for website display
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Email Templates - automated email sequences
    match /email_templates/{templateId} {
      allow read, write: if isAuthenticated();  // Only authenticated users
    }

    // WhatsApp Templates - automated WhatsApp messages
    match /whatsapp_templates/{templateId} {
      allow read, write: if isAuthenticated();  // Only authenticated users
    }

    // Chatbot Responses - chatbot conversation flows
    match /chatbot_responses/{responseId} {
      allow read: if true;  // Public read for chatbot
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Discount Campaigns - seasonal discount campaigns
    match /discount_campaigns/{campaignId} {
      allow read: if true;  // Public read for website display
      allow write: if isAuthenticated();  // Authenticated users can manage
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ========================================
// FIREBASE STORAGE RULES
// ========================================
// Controls access to Firebase Storage (file uploads/downloads)

service firebase.storage {
  match /b/{bucket}/o {

    // ========================================
    // PRODUCT IMAGES FOLDER
    // ========================================
    // Stores product photos uploaded from admin panel
    // Used for displaying product images on quotation website
    match /products/{imageId} {
      // Anyone can read/download product images (needed for quotation website)
      allow read: if true;

      // Only authenticated users can upload/update/delete product images
      allow write, delete: if request.auth != null
                          && request.resource.size < 5 * 1024 * 1024  // Max 5MB
                          && request.resource.contentType.matches('image/.*');  // Images only
    }

    // ========================================
    // VIDEO UPLOADS FOLDER
    // ========================================
    match /videos/{videoId} {
      // Anyone can read videos (for website display)
      allow read: if true;

      // Only authenticated users can upload videos
      allow write, delete: if request.auth != null
                          && request.resource.size < 100 * 1024 * 1024;  // Max 100MB
    }

    // ========================================
    // ADVERTISEMENTS FOLDER
    // ========================================
    match /advertisements/{adId} {
      // Anyone can read ads (for website display)
      allow read: if true;

      // Only authenticated users can upload/manage ads
      allow write, delete: if request.auth != null
                          && request.resource.size < 10 * 1024 * 1024;  // Max 10MB
    }

    // ========================================
    // QUOTATION ATTACHMENTS
    // ========================================
    match /quotations/{quotationId}/{fileName} {
      // Only authenticated users can read quotation attachments
      allow read: if request.auth != null;

      // Only authenticated users can upload quotation attachments
      allow write, delete: if request.auth != null
                          && request.resource.size < 20 * 1024 * 1024;  // Max 20MB
    }

    // ========================================
    // MARKETING & CONVERSION ASSETS
    // ========================================
    // Storage for popup backgrounds, testimonial images, etc.

    // Exit Intent Popup backgrounds and images
    match /popups/{imageId} {
      // Anyone can read popup images (for website display)
      allow read: if true;

      // Only authenticated users can upload popup images
      allow write, delete: if request.auth != null
                          && request.resource.size < 5 * 1024 * 1024  // Max 5MB
                          && request.resource.contentType.matches('image/.*');  // Images only
    }

    // Testimonial images and videos
    match /testimonials/{mediaId} {
      // Anyone can read testimonial media (for website display)
      allow read: if true;

      // Only authenticated users can upload testimonial media
      allow write, delete: if request.auth != null
                          && request.resource.size < 20 * 1024 * 1024;  // Max 20MB
    }

    // Before/After gallery images
    match /before_after/{imageId} {
      // Anyone can read before/after images (for website display)
      allow read: if true;

      // Only authenticated users can upload images
      allow write, delete: if request.auth != null
                          && request.resource.size < 5 * 1024 * 1024  // Max 5MB
                          && request.resource.contentType.matches('image/.*');  // Images only
    }

    // Trust element badges and certifications
    match /trust_elements/{imageId} {
      // Anyone can read trust badges (for website display)
      allow read: if true;

      // Only authenticated users can upload badges
      allow write, delete: if request.auth != null
                          && request.resource.size < 2 * 1024 * 1024;  // Max 2MB
    }

    // ========================================
    // DEFAULT DENY ALL
    // ========================================
    // Block access to everything else for security
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
