<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Photos to Inventory Items</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #8B5CF6;
            padding-bottom: 0.5rem;
        }
        .section {
            background: white;
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .item {
            padding: 1rem;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }
        .item.has-photo {
            background: #d4edda;
            border-color: #28a745;
        }
        .item.needs-photo {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .photo-select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-primary {
            background: #8B5CF6;
            color: white;
        }
        .btn-primary:hover {
            background: #7C3AED;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .status {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        #log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 1rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üì∏ Map Photos to Inventory Items</h1>

    <div class="section">
        <h2>Available Photos</h2>
        <div id="available-photos"></div>
    </div>

    <div class="section">
        <h2>Inventory Items</h2>
        <button class="btn btn-primary" onclick="loadInventory()">üîÑ Load Inventory</button>
        <button class="btn btn-success" onclick="saveAllMappings()" style="margin-left: 1rem;">üíæ Save All Mappings</button>
        <div id="inventory-items" style="margin-top: 1rem;"></div>
    </div>

    <div class="section">
        <h2>Console Log</h2>
        <div id="log"></div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, collection, getDocs, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC5c2BmVHnbWlBwwHtFwll97nq_xOdqxCc",
            authDomain: "firepowersfx-2558.firebaseapp.com",
            projectId: "firepowersfx-2558",
            storageBucket: "firepowersfx-2558.firebasestorage.app",
            messagingSenderId: "723483292867",
            appId: "1:723483292867:web:d6d83a79ba87cd2dee5e76"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.firestoreModules = { doc, collection, getDocs, updateDoc };

        log('‚úÖ Firebase initialized');
    </script>

    <script>
        // Available photos in /admin/ directory
        const availablePhotos = [
            { filename: 'bubble from Disney.png', name: 'Bubble from Disney' },
            { filename: 'circle flame.jpg', name: 'Circle Flame' },
            { filename: 'flame machine 1.jpg', name: 'Flame Machine 1' },
            { filename: 'flames machine.jpg', name: 'Flames Machine' },
            { filename: 'peper ribbon thrower.jpg', name: 'Paper Ribbon Thrower' },
            { filename: 'sparkle fountain image 1.jpg', name: 'Sparkle Fountain' }
        ];

        let inventoryItems = [];
        let categories = [];
        let photoMappings = {};

        // Display available photos
        function displayAvailablePhotos() {
            const container = document.getElementById('available-photos');
            container.innerHTML = availablePhotos.map(photo => `
                <div style="display: inline-block; margin: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                    <strong>${photo.name}</strong><br>
                    <small style="color: #666;">${photo.filename}</small>
                </div>
            `).join('');
        }

        // Log to console
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Load inventory from Firestore
        async function loadInventory() {
            try {
                log('üì¶ Loading inventory from Firestore...');

                const { doc, collection, getDocs } = window.firestoreModules;

                // Load categories
                const categoriesRef = collection(doc(window.db, 'inventory', 'categories'), 'items');
                const categoriesSnapshot = await getDocs(categoriesRef);
                categories = [];
                categoriesSnapshot.forEach(docSnap => {
                    categories.push({ id: docSnap.id, ...docSnap.data() });
                });

                // Load items
                const itemsRef = collection(doc(window.db, 'inventory', 'items'), 'list');
                const itemsSnapshot = await getDocs(itemsRef);
                inventoryItems = [];
                itemsSnapshot.forEach(docSnap => {
                    inventoryItems.push({ id: docSnap.id, ...docSnap.data() });
                });

                log(`‚úÖ Loaded ${categories.length} categories and ${inventoryItems.length} items`);

                displayInventoryItems();
            } catch (error) {
                log(`‚ùå Error loading inventory: ${error.message}`);
                console.error(error);
            }
        }

        // Display inventory items with photo mapping dropdowns
        function displayInventoryItems() {
            const container = document.getElementById('inventory-items');

            if (inventoryItems.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No items loaded yet. Click "Load Inventory" button above.</p>';
                return;
            }

            container.innerHTML = inventoryItems.map(item => {
                const category = categories.find(c => c.id === item.categoryId);
                const hasPhoto = item.imageUrl && item.imageUrl !== '';
                const suggestedPhoto = suggestPhotoForItem(item);

                return `
                    <div class="item ${hasPhoto ? 'has-photo' : 'needs-photo'}">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small style="color: #666;">${category ? category.name : 'No category'}</small>
                        </div>
                        <div>
                            <select class="photo-select" id="photo-${item.id}" onchange="updateMapping('${item.id}', this.value)">
                                <option value="">-- No photo --</option>
                                ${availablePhotos.map(photo => `
                                    <option value="admin/${photo.filename}"
                                        ${item.imageUrl === 'admin/' + photo.filename ? 'selected' : ''}
                                        ${suggestedPhoto === photo.filename ? 'style="background: #ffffcc;"' : ''}>
                                        ${photo.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            ${hasPhoto ?
                                `<span class="status success">‚úì Has Photo</span>` :
                                `<span class="status warning">‚ö† Needs Photo</span>`
                            }
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="saveMapping('${item.id}')">Save</button>
                        </div>
                    </div>
                `;
            }).join('');

            log(`üìã Displayed ${inventoryItems.length} items`);
        }

        // Suggest photo for item based on name matching
        function suggestPhotoForItem(item) {
            const itemName = item.name.toLowerCase();

            // Try to match based on keywords
            if (itemName.includes('bubble')) return 'bubble from Disney.png';
            if (itemName.includes('circle') && itemName.includes('flame')) return 'circle flame.jpg';
            if (itemName.includes('flame machine') || itemName.includes('flames machine')) return 'flames machine.jpg';
            if (itemName.includes('ribbon') || itemName.includes('paper')) return 'peper ribbon thrower.jpg';
            if (itemName.includes('sparkle') || itemName.includes('fountain')) return 'sparkle fountain image 1.jpg';

            return null;
        }

        // Update mapping in memory
        function updateMapping(itemId, photoPath) {
            photoMappings[itemId] = photoPath;
            log(`üìù Updated mapping for item ${itemId}: ${photoPath}`);
        }

        // Save single mapping to Firestore
        async function saveMapping(itemId) {
            try {
                const select = document.getElementById(`photo-${itemId}`);
                const photoPath = select.value;

                if (!photoPath) {
                    log(`‚ö†Ô∏è No photo selected for item ${itemId}`);
                    return;
                }

                const { doc, updateDoc } = window.firestoreModules;
                const itemRef = doc(window.db, 'inventory', 'items', 'list', itemId);

                await updateDoc(itemRef, {
                    imageUrl: photoPath
                });

                log(`‚úÖ Saved photo mapping for item ${itemId}: ${photoPath}`);

                // Reload to update UI
                await loadInventory();
            } catch (error) {
                log(`‚ùå Error saving mapping: ${error.message}`);
                console.error(error);
            }
        }

        // Save all mappings at once
        async function saveAllMappings() {
            try {
                log('üíæ Saving all mappings...');

                const { doc, updateDoc } = window.firestoreModules;
                let savedCount = 0;

                for (const item of inventoryItems) {
                    const select = document.getElementById(`photo-${item.id}`);
                    const photoPath = select.value;

                    if (photoPath && photoPath !== item.imageUrl) {
                        const itemRef = doc(window.db, 'inventory', 'items', 'list', item.id);
                        await updateDoc(itemRef, {
                            imageUrl: photoPath
                        });
                        savedCount++;
                        log(`‚úÖ Updated ${item.name} -> ${photoPath}`);
                    }
                }

                log(`üéâ Saved ${savedCount} mappings!`);

                // Reload to update UI
                await loadInventory();
            } catch (error) {
                log(`‚ùå Error saving mappings: ${error.message}`);
                console.error(error);
            }
        }

        // Make functions globally available
        window.loadInventory = loadInventory;
        window.updateMapping = updateMapping;
        window.saveMapping = saveMapping;
        window.saveAllMappings = saveAllMappings;

        // Initialize
        displayAvailablePhotos();
    </script>
</body>
</html>
